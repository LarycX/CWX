{"version":3,"file":"cwDecoder.js","sources":["pages/index/logic/cwDecoder.js"],"sourcesContent":["const MORSE_TABLE = {\n\t\".-\": \"A\",\n\t\"-...\": \"B\",\n\t\"-.-.\": \"C\",\n\t\"-..\": \"D\",\n\t\".\": \"E\",\n\t\"..-.\": \"F\",\n\t\"--.\": \"G\",\n\t\"....\": \"H\",\n\t\"..\": \"I\",\n\t\".---\": \"J\",\n\t\"-.-\": \"K\",\n\t\".-..\": \"L\",\n\t\"--\": \"M\",\n\t\"-.\": \"N\",\n\t\"---\": \"O\",\n\t\".--.\": \"P\",\n\t\"--.-\": \"Q\",\n\t\".-.\": \"R\",\n\t\"...\": \"S\",\n\t\"-\": \"T\",\n\t\"..-\": \"U\",\n\t\"...-\": \"V\",\n\t\".--\": \"W\",\n\t\"-..-\": \"X\",\n\t\"-.--\": \"Y\",\n\t\"--..\": \"Z\",\n\t\"-----\": \"0\",\n\t\".----\": \"1\",\n\t\"..---\": \"2\",\n\t\"...--\": \"3\",\n\t\"....-\": \"4\",\n\t\".....\": \"5\",\n\t\"-....\": \"6\",\n\t\"--...\": \"7\",\n\t\"---..\": \"8\",\n\t\"----.\": \"9\",\n\t\".-.-.-\": \".\",\n\t\"--..--\": \",\",\n\t\"..--..\": \"?\",\n\t\".----.\": \"'\",\n\t\"-.-.--\": \"!\",\n\t\"-..-.\": \"/\",\n\t\"-.--.\": \"(\",\n\t\"-.--.-\": \")\",\n\t\".-...\": \"&\",\n\t\"---...\": \":\",\n\t\"-.-.-.\": \";\",\n\t\"-...-\": \"=\",\n\t\".-.-.\": \"+\",\n\t\"-....-\": \"-\",\n\t\"..--.-\": \"_\",\n\t\".-..-.\": \"\\\"\",\n\t\"...-..-\": \"$\",\n\t\".--.-.\": \"@\"\n};\n\nconst decodeMarks = (marks) => {\n\tif (!marks.length) return \"\";\n\tconst key = marks.join(\"\");\n\treturn MORSE_TABLE[key] || \"?\";\n};\n\nclass CwDecoderEngine {\n\tconstructor() {\n\t\tthis.reset();\n\t}\n\n\treset() {\n\t\tthis.isRecording = false;\n\t\tthis.lastMarkEndAt = 0;\n\t\tthis.currentMarks = [];\n\t\tthis.lastDecodedAt = 0;\n\t\tthis.nextWordSpacePending = false;\n\t}\n\n\tensureRecordingSession() {\n\t\tif (this.isRecording) return;\n\t\tthis.isRecording = true;\n\t\tthis.currentMarks = [];\n\t}\n\n\t/**\n\t * 方案A：recordMark 只记录 tone，不再自动追加 1u gap。\n\t * gap 只来自：\n\t *  1) 调度 startAt 与 recordCursorMs 的差（lead silence）\n\t *  2) 外部显式 extendGap（字符/单词超时）\n\t */\n\trecordMark(mark, startAt, unitMs) {\n\t\tthis.ensureRecordingSession();\n\t\tif (this.lastMarkEndAt) {\n\t\t\tconst gapMs = Math.max(0, startAt - this.lastMarkEndAt);\n\t\t\tif (gapMs >= unitMs * 10) {\n\t\t\t\tthis.nextWordSpacePending = true;\n\t\t\t}\n\t\t}\n\t\tconst markUnits = mark === \"-\" ? 3 : 1;\n\t\tconst toneMs = unitMs * markUnits;\n\t\tthis.lastMarkEndAt = startAt + toneMs;\n\t\tthis.currentMarks.push(mark);\n\t}\n\n\tflushChar(withSpace) {\n\t\tif (!this.currentMarks.length) {\n\t\t\treturn { text: \"\", withSpace: false };\n\t\t}\n\t\tconst decoded = decodeMarks(this.currentMarks);\n\t\tconst shouldSpace = withSpace || this.nextWordSpacePending;\n\t\tthis.currentMarks = [];\n\t\tif (decoded) {\n\t\t\tthis.lastDecodedAt = Date.now();\n\t\t\tthis.nextWordSpacePending = false;\n\t\t}\n\t\treturn { text: decoded, withSpace: shouldSpace };\n\t}\n\n\t/**\n\t * stop 只做“收尾 flush”，不再依赖 gapExtraUnits。\n\t * 为了让最后一个字符稳定提交：确保尾部至少有 7u gap（单词结束语义）。\n\t */\n\tstopRecordingAndDecode() {\n\t\tif (!this.isRecording) {\n\t\t\treturn { text: \"\", withSpace: false };\n\t\t}\n\t\tthis.isRecording = false;\n\t\tthis.lastMarkEndAt = 0;\n\t\treturn this.flushChar(true);\n\t}\n}\n\nexport default CwDecoderEngine;\n"],"names":[],"mappings":";AAAA,MAAM,cAAc;AAAA,EACnB,MAAM;AAAA,EACN,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,KAAK;AAAA,EACL,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,MAAM;AAAA,EACN,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,MAAM;AAAA,EACN,MAAM;AAAA,EACN,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,OAAO;AAAA,EACP,KAAK;AAAA,EACL,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,SAAS;AAAA,EACT,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,SAAS;AAAA,EACT,SAAS;AAAA,EACT,UAAU;AAAA,EACV,SAAS;AAAA,EACT,UAAU;AAAA,EACV,UAAU;AAAA,EACV,SAAS;AAAA,EACT,SAAS;AAAA,EACT,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,WAAW;AAAA,EACX,UAAU;AACX;AAEA,MAAM,cAAc,CAAC,UAAU;AAC9B,MAAI,CAAC,MAAM;AAAQ,WAAO;AAC1B,QAAM,MAAM,MAAM,KAAK,EAAE;AACzB,SAAO,YAAY,GAAG,KAAK;AAC5B;AAEA,MAAM,gBAAgB;AAAA,EACrB,cAAc;AACb,SAAK,MAAK;AAAA,EACV;AAAA,EAED,QAAQ;AACP,SAAK,cAAc;AACnB,SAAK,gBAAgB;AACrB,SAAK,eAAe;AACpB,SAAK,gBAAgB;AACrB,SAAK,uBAAuB;AAAA,EAC5B;AAAA,EAED,yBAAyB;AACxB,QAAI,KAAK;AAAa;AACtB,SAAK,cAAc;AACnB,SAAK,eAAe;EACpB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQD,WAAW,MAAM,SAAS,QAAQ;AACjC,SAAK,uBAAsB;AAC3B,QAAI,KAAK,eAAe;AACvB,YAAM,QAAQ,KAAK,IAAI,GAAG,UAAU,KAAK,aAAa;AACtD,UAAI,SAAS,SAAS,IAAI;AACzB,aAAK,uBAAuB;AAAA,MAC5B;AAAA,IACD;AACD,UAAM,YAAY,SAAS,MAAM,IAAI;AACrC,UAAM,SAAS,SAAS;AACxB,SAAK,gBAAgB,UAAU;AAC/B,SAAK,aAAa,KAAK,IAAI;AAAA,EAC3B;AAAA,EAED,UAAU,WAAW;AACpB,QAAI,CAAC,KAAK,aAAa,QAAQ;AAC9B,aAAO,EAAE,MAAM,IAAI,WAAW,MAAK;AAAA,IACnC;AACD,UAAM,UAAU,YAAY,KAAK,YAAY;AAC7C,UAAM,cAAc,aAAa,KAAK;AACtC,SAAK,eAAe;AACpB,QAAI,SAAS;AACZ,WAAK,gBAAgB,KAAK;AAC1B,WAAK,uBAAuB;AAAA,IAC5B;AACD,WAAO,EAAE,MAAM,SAAS,WAAW,YAAW;AAAA,EAC9C;AAAA;AAAA;AAAA;AAAA;AAAA,EAMD,yBAAyB;AACxB,QAAI,CAAC,KAAK,aAAa;AACtB,aAAO,EAAE,MAAM,IAAI,WAAW,MAAK;AAAA,IACnC;AACD,SAAK,cAAc;AACnB,SAAK,gBAAgB;AACrB,WAAO,KAAK,UAAU,IAAI;AAAA,EAC1B;AACF;;"}